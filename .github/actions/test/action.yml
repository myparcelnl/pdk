name: 'Run tests'
description: 'Run Pest tests and upload coverage'

runs:
  using: composite
  steps:
    - name: 'Handle coverage cache'
      uses: actions/cache@v2
      id: coverage-cache
      with:
        path: ./clover.xml
        key: ${{ runner.os }}-coverage-clover-${{ hashFiles('**/composer.lock', './src/**', './tests/**') }}

    - uses: ./.github/actions/setup
      if: steps.coverage-cache.outputs.cache-hit != 'true'

    - name: 'Run tests'
      if: steps.coverage-cache.outputs.cache-hit != 'true'
      shell: bash
      run: |
        docker compose run php \
          php -dpcov.enabled=1 \
          vendor/bin/pest --coverage-clover clover.xml

        # Strip the /app/ prefix from the coverage paths before uploading.
        sed -i 's/\/app\///g' clover.xml

    - uses: codecov/codecov-action@v3
      continue-on-error: true
